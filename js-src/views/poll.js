'use strict';

define([
  'text!templates/poll-form.html.tpl',
  'text!templates/poll-submit.html.tpl',
  'models/poll-form',
  'models/poll-submit',
  //
  'jquery',
  'icheck'
], function(
        templateForm,
        templateSubmit,
        modelForm,
        modelSubmit
        )
{
  var PollView = Backbone.View.extend({
    // variables
    templateForm: _.template(templateForm),
    templateSubmit: _.template(templateSubmit),
    pollId: false,
    $elem: $(),
    goToUrl: false,
    modelForm: false,
    modelSubmit: false,
    appThumborConfig: false,
    // init
    initialize: function(attributes) {
      this.appThumborConfig = $.extend(true, {}, window.appThumborConfig, {thumbor: {hasResize: true, hasTrim: false, isSmart: true}}, {thumbor: attributes.thumbor});
      this.pollId = attributes.pollId;
      this.$elem = attributes.$elem;
      if (this.$elem.data('go-to-url')) {
        this.goToUrl = this.$elem.data('go-to-url');
      }
      this.pollFormGet();
    },
    // actions
    pollFormGet: function() {
      var _this = this;
      var model = new modelForm({pollId: this.pollId});

      model.fetch({success: function() {
          _this.modelForm = model;
          _this.pollFormRender();
        }
      });
    },
    pollFormRender: function() {
      var _this = this;
      // image
      _.each(this.modelForm.attributes.elements, function(e) {
        if (e.type === "image") {
          var thumbor = new thumborUrlBuilder(_this.appThumborConfig);
          thumbor.setAmazonUrlPath(_this.appThumborConfig.amazonS3Path, e.data);
          _this.modelForm.set('img', thumbor.finalUrl());
        }
      });
      //
      this.$elem.html(this.templateForm(this.modelForm.attributes));
      this.$elem.find('input').iCheck({
        checkboxClass: 'icheckbox_minimal',
        radioClass: 'iradio_minimal',
        increaseArea: '20%'
      });
      this.$elem.find("input[type='submit']").click(function(e) {
        e.preventDefault();
        var answerId = $(this).closest('form').find("input:radio:checked").attr('value');
        if (answerId) {
          _this.pollSubmit(answerId);
        } else {
          _this.formError(_this.$elem.find('form .w__poll--radios'), _this.t("Select Anawer"));
        }


      });
      //pollSubmit

    },
    pollSubmit: function(answerId) {
      var _this = this;
      this.modelSubmit = new modelSubmit({answerId: answerId, pollId: this.pollId});
      this.modelSubmit.save({}, {
        success: function() {
          _this.pollSubmitRender();
        },
        error: function() {
          _this.modelSubmit.fetch2({
            success: function() {
              _this.pollSubmitRender();
            }
          });
        }
      });
    },
    pollSubmitRender: function() {
      var statisticElementsIdKey = {};
      var tthis = this;
      var answerSumm = 0;
      $(this.modelSubmit.attributes.elements).each(function(i, statisticElement) {
        statisticElementsIdKey[statisticElement.answerId] = statisticElement.answerCount;
        answerSumm = answerSumm + parseInt(statisticElement.answerCount);
      });
      $(this.modelForm.attributes.elements).each(function(i, questionElement) {
        if (questionElement.type === "poll_answer") {
          questionElement.answerCount = statisticElementsIdKey[questionElement.id];
          if (questionElement.answerCount) {
            questionElement.procents = Math.ceil((questionElement.answerCount / answerSumm) * 100);
          } else {
            questionElement.procents = 0;
          }
        }
      });
      this.$elem.html(this.templateSubmit(this.modelForm.attributes));
      setTimeout(function() {
        tthis.$elem.find('.w-poll__statistics').addClass('animation-trigger');
      }, 0);
    },
    formError: function(element, text, display, tmsg) {
      if ($(element).is('form')) {
        var $form = $(element);
      } else {
        var $form = $(element).closest('form');
      }
      text = text || "input error";
      display = display || $form.find(".form-err");
      tmsg = tmsg || 4500;
      var tef = (window.navigator.userAgent.indexOf("MSIE 8") > 0) ? 0 : 500;


      $(display).css({opacity: 0, display: ""});
      $(element).css({outline: "1px solid red"});

      $(display).html(text);
      $(display).fadeTo(tef, 1);

      setTimeout(function() {
        $(display).fadeTo(tef, 0, function() {
          $(display).css({display: "none"});
          $(element).css({outline: ""});
        });
      }, tmsg);
    }


  });

  return PollView;

});